{% extends "base.html" %}

{% block title %}Assessment Detail - SteadywellOS{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2><i class="fas fa-clipboard-check me-2"></i>Assessment Detail</h2>
    </div>
    <div class="col-md-6 text-md-end">
        <a href="/assessments" class="btn btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i> Back to Assessments
        </a>
        <button class="btn btn-success" id="scheduleFollowupBtn">
            <i class="fas fa-calendar-plus me-1"></i> Schedule Follow-up
        </button>
    </div>
</div>

<!-- Assessment Overview -->
<div class="row">
    <!-- Assessment Info -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Assessment Information</h5>
            </div>
            <div class="card-body" id="assessmentInfoCard">
                <!-- Will be populated by JavaScript -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Patient Info -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Patient Information</h5>
            </div>
            <div class="card-body" id="patientInfoCard">
                <!-- Will be populated by JavaScript -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Symptoms and Interventions -->
<div class="row">
    <!-- Symptoms -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Reported Symptoms</h5>
            </div>
            <div class="card-body" id="symptomsCard">
                <!-- Will be populated by JavaScript -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Interventions -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Recommended Interventions</h5>
            </div>
            <div class="card-body" id="interventionsCard">
                <!-- Will be populated by JavaScript -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Guidance and Notes -->
<div class="row">
    <!-- AI Guidance -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">AI-Generated Guidance</h5>
            </div>
            <div class="card-body" id="aiGuidanceCard">
                <!-- Will be populated by JavaScript -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clinical Notes -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Clinical Notes</h5>
                <button class="btn btn-sm btn-primary" id="editNotesBtn">
                    <i class="fas fa-edit me-1"></i> Edit
                </button>
            </div>
            <div class="card-body">
                <div id="notesViewSection">
                    <p id="notesContent">Loading...</p>
                </div>
                <div id="notesEditSection" style="display: none;">
                    <form id="notesForm">
                        <div class="mb-3">
                            <textarea id="notesTextarea" class="form-control" rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="followUpNeeded">
                                <label class="form-check-label" for="followUpNeeded">
                                    Follow-up Needed
                                </label>
                            </div>
                        </div>
                        <div id="followUpOptions" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="followUpDate" class="form-label">Follow-up Date</label>
                                        <input type="date" id="followUpDate" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="followUpPriority" class="form-label">Priority</label>
                                        <select id="followUpPriority" class="form-select">
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                            <option value="urgent">Urgent</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" id="cancelNotesBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Responses -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Assessment Responses</h5>
    </div>
    <div class="card-body" id="responsesCard">
        <!-- Will be populated by JavaScript -->
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Get assessment ID from URL
    const assessmentId = window.location.pathname.split('/').pop();
    let assessmentData = null;
    let patientData = null;
    let protocolData = null;
    
    // Load assessment data
    function loadAssessment() {
        console.log("Loading assessment ID:", assessmentId);
        console.log("Authorization token:", localStorage.getItem('auth_token'));
        
        // If no token, create a demo token
        if (!localStorage.getItem('auth_token')) {
            console.log("No auth token found - creating a demo token");
            // Create a fake token for demo purposes
            localStorage.setItem('auth_token', 'demo-token-for-testing');
            
            // Create a fake user for the demo
            localStorage.setItem('current_user', JSON.stringify({
                id: 1,
                username: 'demo_user',
                full_name: 'Demo User',
                role: 'NURSE'
            }));
        }
        
        fetch(`/api/v1/assessments/${assessmentId}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
            }
        })
        .then(response => response.json())
        .then(data => {
            // Store data globally
            assessmentData = data;
            
            // Log assessment data for debugging
            console.log("Assessment data loaded:", data);
            console.log("Protocol info in assessment:", data.protocol);
            console.log("Protocol ID location check:", {
                "data.protocol_id": data.protocol_id,
                "data.protocol?.id": data.protocol?.id
            });
            
            // Format assessment date
            const assessmentDate = new Date(data.assessment_date).toLocaleString();
            
            // Populate assessment info card with defensive checks for missing data
            document.getElementById('assessmentInfoCard').innerHTML = `
                <p><strong>Date:</strong> ${assessmentDate}</p>
                ${data.protocol ? `
                    <p><strong>Protocol:</strong> ${data.protocol.name}</p>
                    <p><strong>Protocol Type:</strong> ${data.protocol.protocol_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                ` : `
                    <p><strong>Protocol:</strong> <span class="text-muted">Not specified</span></p>
                    <p><strong>Protocol Type:</strong> <span class="text-muted">Not specified</span></p>
                `}
                <p><strong>Conducted By:</strong> ${data.conducted_by?.full_name || 'Unknown'}</p>
                ${data.call_id ? `<p><strong>Associated Call:</strong> <a href="/calls/${data.call_id}">View Call</a></p>` : ''}
                <p><strong>Follow-up:</strong> ${data.follow_up_needed ? 'Yes' : 'No'}</p>
                ${data.follow_up_needed ? `
                    <p><strong>Follow-up Date:</strong> ${new Date(data.follow_up_date).toLocaleDateString()}</p>
                    <p><strong>Priority:</strong> <span class="badge ${getPriorityBadgeClass(data.follow_up_priority)}">${data.follow_up_priority.toUpperCase()}</span></p>
                ` : ''}
            `;
            
            // Populate notes section
            const notesContent = document.getElementById('notesContent');
            notesContent.textContent = data.notes ? data.notes : 'No clinical notes recorded.';
            
            // Set form values for notes editing
            document.getElementById('notesTextarea').value = data.notes || '';
            document.getElementById('followUpNeeded').checked = data.follow_up_needed || false;
            
            if (data.follow_up_needed) {
                document.getElementById('followUpOptions').style.display = 'block';
                if (data.follow_up_date) {
                    const followUpDate = new Date(data.follow_up_date);
                    const year = followUpDate.getFullYear();
                    const month = String(followUpDate.getMonth() + 1).padStart(2, '0');
                    const day = String(followUpDate.getDate()).padStart(2, '0');
                    document.getElementById('followUpDate').value = `${year}-${month}-${day}`;
                }
                if (data.follow_up_priority) {
                    document.getElementById('followUpPriority').value = data.follow_up_priority;
                }
            }
            
            // Load patient data
            fetch(`/api/v1/patients/${data.patient_id}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                }
            })
            .then(response => response.json())
            .then(patient => {
                patientData = patient;
                
                // Format protocol type for display
                const protocolDisplay = patient.protocol_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                // Populate patient info card
                document.getElementById('patientInfoCard').innerHTML = `
                    <p><strong>Name:</strong> <a href="/patients/${patient.id}">${patient.full_name}</a></p>
                    <p><strong>MRN:</strong> ${patient.mrn}</p>
                    <p><strong>Age:</strong> ${patient.age} years</p>
                    <p><strong>Primary Diagnosis:</strong> ${patient.primary_diagnosis}</p>
                    <p><strong>Protocol Type:</strong> ${protocolDisplay}</p>
                    <p><strong>Primary Nurse:</strong> ${patient.primary_nurse ? patient.primary_nurse.full_name : 'Unassigned'}</p>
                `;
            })
            .catch(error => {
                console.error('Error fetching patient data:', error);
                document.getElementById('patientInfoCard').innerHTML = 'Error loading patient information.';
            });
            
            // Load protocol data - use the protocol ID from nested protocol object or fall back to protocol_id property
            const protocolId = data.protocol?.id || data.protocol_id;
            console.log("Using protocol ID:", protocolId);
            
            // Handle missing protocol directly for symptoms and interventions
            // We'll still continue with the protocol fetch if we have an ID, but render the symptoms/interventions
            // directly from assessment data if available
            
            // Process and display symptoms regardless of protocol presence
            processAndDisplaySymptoms(data);
            
            // Process and display interventions regardless of protocol presence
            processAndDisplayInterventions(data);
            
            // Process and display responses if available, even without protocol
            processAndDisplayResponses(data);
            
            // Skip protocol fetch if no ID
            if (!protocolId) {
                console.warn("No protocol ID found in assessment data:", data);
                // Try to fetch protocol based on patient's protocol_type
                if (patientData && patientData.protocol_type) {
                    console.log("Attempting to find a protocol based on patient protocol type:", patientData.protocol_type);
                    fetch(`/api/v1/protocols?protocol_type=${patientData.protocol_type}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    })
                    .then(response => response.json())
                    .then(protocols => {
                        if (protocols && protocols.length > 0) {
                            console.log("Found protocol for patient protocol type:", protocols[0]);
                            protocolData = protocols[0];
                            // Continue with protocol data processing
                        } else {
                            console.warn("No protocols found for type:", patientData.protocol_type);
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching protocols by type:", error);
                    });
                }
                return;
            }
            
            fetch(`/api/v1/protocols/${protocolId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Protocol API returned status: ${response.status}`);
                }
                return response.json();
            })
            .then(protocol => {
                protocolData = protocol;
                console.log("Protocol data loaded successfully:", protocol);
                
                // Process and display symptoms
                const symptomsContent = document.getElementById('symptomsCard');
                // Create a more standardized symptoms object with fallbacks and validations
                let processedSymptoms = {};
                
                // Check if symptoms data exists and is in expected format
                if (data.symptoms && typeof data.symptoms === 'object') {
                    // Create a standardized copy of the symptoms with validation
                    Object.entries(data.symptoms).forEach(([symptom, severity]) => {
                        // Convert any non-numeric severity to 0 or the provided value
                        const numericSeverity = typeof severity === 'number' 
                            ? severity 
                            : (typeof severity === 'object' && severity?.value && !isNaN(severity.value)) 
                                ? Number(severity.value) 
                                : 0;
                                
                        // Only include valid symptom data
                        if (symptom && numericSeverity !== undefined) {
                            processedSymptoms[symptom] = numericSeverity;
                        }
                    });
                }
                
                console.log("Processed symptoms:", processedSymptoms);
                
                if (Object.keys(processedSymptoms).length > 0) {
                    // Sort symptoms by severity (descending)
                    const sortedSymptoms = Object.entries(processedSymptoms)
                        .filter(([_, severity]) => typeof severity === 'number')
                        .sort((a, b) => b[1] - a[1]);
                    
                    let symptomsHtml = '<div class="table-responsive"><table class="table table-hover">';
                    symptomsHtml += '<thead><tr><th>Symptom</th><th>Severity</th><th>Level</th></tr></thead><tbody>';
                    
                    sortedSymptoms.forEach(([symptom, severity]) => {
                        // Determine severity level
                        let levelClass = 'bg-success';
                        let levelText = 'Mild';
                        
                        if (severity >= 7) {
                            levelClass = 'bg-danger';
                            levelText = 'Severe';
                        } else if (severity >= 4) {
                            levelClass = 'bg-warning';
                            levelText = 'Moderate';
                        }
                        
                        // Format symptom name for display
                        const symptomDisplay = symptom.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        
                        symptomsHtml += `
                            <tr>
                                <td>${symptomDisplay}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar ${levelClass}" role="progressbar" style="width: ${severity * 10}%;" 
                                             aria-valuenow="${severity}" aria-valuemin="0" aria-valuemax="10">
                                            ${severity}/10
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge ${levelClass}">${levelText}</span></td>
                            </tr>
                        `;
                    });
                    
                    symptomsHtml += '</tbody></table></div>';
                    symptomsContent.innerHTML = symptomsHtml;
                } else {
                    symptomsContent.innerHTML = '<p>No symptoms reported.</p>';
                }
                
                // Process and display interventions
                const interventionsContent = document.getElementById('interventionsCard');
                
                // Validate and standardize interventions data
                let validInterventions = [];
                if (data.interventions) {
                    // Ensure interventions is an array
                    const interventionsArray = Array.isArray(data.interventions) 
                        ? data.interventions 
                        : typeof data.interventions === 'object' 
                            ? [data.interventions] 
                            : [];
                    
                    // Process each intervention
                    interventionsArray.forEach(intervention => {
                        // Skip invalid interventions
                        if (!intervention || typeof intervention !== 'object') {
                            return;
                        }
                        
                        // Add to valid interventions
                        validInterventions.push(intervention);
                    });
                }
                
                console.log("Valid interventions:", validInterventions);
                
                if (validInterventions.length > 0) {
                    let interventionsHtml = '<ul class="list-group">';
                    
                    validInterventions.forEach(intervention => {
                        // Handle various intervention formats
                        const title = intervention.title || intervention.name || intervention.id || "Intervention";
                        const description = intervention.description || "";
                        
                        // Determine priority class (if available)
                        let priorityClass = 'bg-info';
                        let priorityText = '';
                        
                        if (intervention.priority) {
                            if (intervention.priority === 'high') priorityClass = 'bg-danger';
                            if (intervention.priority === 'medium') priorityClass = 'bg-warning';
                            if (intervention.priority === 'low') priorityClass = 'bg-success';
                            priorityText = `<span class="badge ${priorityClass}">${intervention.priority.toUpperCase()}</span>`;
                        } else if (intervention.severity_threshold) {
                            // Use severity threshold as alternative
                            if (intervention.severity_threshold >= 7) {
                                priorityClass = 'bg-danger';
                                priorityText = '<span class="badge bg-danger">HIGH</span>';
                            } else if (intervention.severity_threshold >= 4) {
                                priorityClass = 'bg-warning';
                                priorityText = '<span class="badge bg-warning">MEDIUM</span>';
                            } else {
                                priorityClass = 'bg-success';
                                priorityText = '<span class="badge bg-success">LOW</span>';
                            }
                        }
                        
                        interventionsHtml += `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6>${title}</h6>
                                    ${priorityText}
                                </div>
                                <p>${description}</p>
                                ${intervention.instructions ? `<small class="text-muted">${intervention.instructions}</small>` : ''}
                            </li>
                        `;
                    });
                    
                    interventionsHtml += '</ul>';
                    interventionsContent.innerHTML = interventionsHtml;
                } else {
                    interventionsContent.innerHTML = '<p>No interventions recommended.</p>';
                }
                
                // Process and display responses
                const responsesContent = document.getElementById('responsesCard');
                
                // Standardize responses data
                const standardizedResponses = {};
                
                // Process responses if they exist
                if (data.responses && typeof data.responses === 'object') {
                    // Process each response
                    Object.entries(data.responses).forEach(([questionId, response]) => {
                        // Handle different response formats
                        if (questionId) {
                            if (typeof response === 'object' && response !== null) {
                                standardizedResponses[questionId] = response;
                            } else {
                                // Create a standard format for non-object responses
                                standardizedResponses[questionId] = {
                                    value: response,
                                    notes: ''
                                };
                            }
                        }
                    });
                }
                
                console.log("Standardized responses:", standardizedResponses);
                
                if (Object.keys(standardizedResponses).length > 0) {
                    // Ensure protocol has questions defined
                    if (!protocol.questions || !Array.isArray(protocol.questions)) {
                        responsesContent.innerHTML = '<div class="alert alert-warning">Unable to display detailed responses: Protocol questions format is invalid.</div>';
                        
                        // Show raw responses as fallback
                        let rawResponsesHtml = '<div class="mt-3"><h6>Raw Responses:</h6><ul>';
                        Object.entries(standardizedResponses).forEach(([questionId, response]) => {
                            rawResponsesHtml += `<li><strong>${questionId}:</strong> ${JSON.stringify(response)}</li>`;
                        });
                        rawResponsesHtml += '</ul></div>';
                        responsesContent.innerHTML += rawResponsesHtml;
                        return;
                    }
                    
                    let responsesHtml = '<div class="accordion" id="responseAccordion">';
                    
                    // Group responses by category
                    const responseCategories = {};
                    const defaultCategory = 'General';
                    
                    Object.entries(standardizedResponses).forEach(([questionId, response]) => {
                        // Find question in protocol
                        const question = protocol.questions.find(q => q.id === questionId);
                        
                        if (question) {
                            // Create category if it doesn't exist
                            const category = question.category || question.symptom_type || defaultCategory;
                            if (!responseCategories[category]) {
                                responseCategories[category] = [];
                            }
                            
                            // Format response based on question type
                            let responseDisplay = '';
                            let responseValue = response.value;
                            
                            // Handle null or undefined values
                            if (responseValue === null || responseValue === undefined) {
                                responseDisplay = 'No response';
                            } else if (question.type === 'numeric') {
                                responseDisplay = `${responseValue}/10`;
                            } else if (question.type === 'boolean') {
                                responseDisplay = responseValue ? 'Yes' : 'No';
                            } else if (question.type === 'choice' || question.type === 'multiple_choice') {
                                responseDisplay = responseValue;
                            } else if (question.type === 'text') {
                                responseDisplay = responseValue;
                            } else {
                                // Default case
                                responseDisplay = String(responseValue);
                            }
                            
                            // Add to category
                            responseCategories[category].push({
                                question: question.text,
                                response: responseDisplay,
                                notes: response.notes || ''
                            });
                        } else {
                            // Question not found in protocol, add to default category
                            if (!responseCategories[defaultCategory]) {
                                responseCategories[defaultCategory] = [];
                            }
                            
                            // Format the response for display
                            let responseDisplay;
                            if (typeof response.value === 'object') {
                                responseDisplay = JSON.stringify(response.value);
                            } else if (response.value === null || response.value === undefined) {
                                responseDisplay = 'No response';
                            } else {
                                responseDisplay = String(response.value);
                            }
                            
                            responseCategories[defaultCategory].push({
                                question: questionId,
                                response: responseDisplay,
                                notes: response.notes || ''
                            });
                        }
                    });
                    
                    // Create accordion for each category
                    Object.entries(responseCategories).forEach(([category, responses], index) => {
                        const categoryDisplay = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        
                        responsesHtml += `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading${index}">
                                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapse${index}" aria-expanded="${index === 0}" aria-controls="collapse${index}">
                                        ${categoryDisplay} (${responses.length} questions)
                                    </button>
                                </h2>
                                <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                     aria-labelledby="heading${index}" data-bs-parent="#responseAccordion">
                                    <div class="accordion-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Question</th>
                                                        <th>Response</th>
                                                        <th>Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                        `;
                        
                        responses.forEach(item => {
                            responsesHtml += `
                                <tr>
                                    <td>${item.question}</td>
                                    <td><strong>${item.response}</strong></td>
                                    <td>${item.notes || ''}</td>
                                </tr>
                            `;
                        });
                        
                        responsesHtml += `
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    responsesHtml += '</div>';
                    responsesContent.innerHTML = responsesHtml;
                } else {
                    responsesContent.innerHTML = '<p>No responses recorded.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching protocol data:', error);
                
                // Since we already displayed the data using our standalone functions,
                // we only need to show a warning that protocol-specific details couldn't be loaded
                const warningHtml = `
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Protocol Details Warning</h6>
                        <p class="mb-0">Additional protocol-specific details could not be loaded. Basic assessment data is still displayed.</p>
                        <small>Error details: ${error.message}</small>
                    </div>
                `;
                
                // Add warning to each card (non-destructively, after existing content)
                document.getElementById('symptomsCard').innerHTML += warningHtml;
                document.getElementById('interventionsCard').innerHTML += warningHtml;
                document.getElementById('responsesCard').innerHTML += warningHtml;
            });
            
            // Display AI guidance
            const aiGuidanceContent = document.getElementById('aiGuidanceCard');
            if (data.ai_guidance) {
                aiGuidanceContent.innerHTML = `
                    <div class="p-3 bg-light rounded">
                        <h6><i class="fas fa-robot me-2"></i>AI Clinical Recommendations</h6>
                        <p class="text-muted mb-0"><small>Generated by StedywellOS AI clinical assistant - verify all guidance</small></p>
                        <hr>
                        <div class="ai-guidance-content">
                            ${formatAIGuidance(data.ai_guidance)}
                        </div>
                    </div>
                `;
            } else {
                aiGuidanceContent.innerHTML = '<p>No AI guidance available for this assessment.</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching assessment data:', error);
            
            // Show more detailed error in the UI
            const errorMessage = `
                <div class="alert alert-danger">
                    <h6>Error fetching assessment data:</h6>
                    <p>${error.message || 'Unknown error'}</p>
                    <p>Assessment ID: ${assessmentId}</p>
                    <hr>
                    <strong>Troubleshooting:</strong>
                    <ul>
                        <li>Check browser console for detailed errors</li>
                        <li>Verify your login session is valid</li>
                        <li>Try refreshing the page</li>
                    </ul>
                    <button class="btn btn-sm btn-primary mt-2" onclick="fixTokenAndRetry()">Try to fix and retry</button>
                </div>
            `;
            
            document.getElementById('assessmentInfoCard').innerHTML = errorMessage;
            document.getElementById('patientInfoCard').innerHTML = 'Error loading patient information.';
            document.getElementById('symptomsCard').innerHTML = 'Error loading symptoms information.';
            document.getElementById('interventionsCard').innerHTML = 'Error loading interventions information.';
            document.getElementById('responsesCard').innerHTML = 'Error loading responses information.';
        });
    }
    
    // Helper function to determine priority badge class
    function getPriorityBadgeClass(priority) {
        if (priority === 'high' || priority === 'urgent') return 'bg-danger';
        if (priority === 'medium') return 'bg-warning';
        if (priority === 'low') return 'bg-success';
        return 'bg-info';
    }
    
    // Format AI guidance text (simple markdown-like formatting)
    function formatAIGuidance(guidance) {
        if (!guidance) return '';
        
        // Replace line breaks with paragraphs
        let formatted = guidance.replace(/\n\n/g, '</p><p>');
        formatted = '<p>' + formatted + '</p>';
        
        // Bold text between ** markers
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Italic text between * markers
        formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        // Lists
        formatted = formatted.replace(/^- (.*)/gm, '<li>$1</li>');
        formatted = formatted.replace(/<li>/g, '<ul><li>').replace(/<\/li>(?!\s*<li>)/g, '</li></ul>');
        
        return formatted;
    }
    
    // Toggle notes edit section
    document.getElementById('editNotesBtn').addEventListener('click', function() {
        document.getElementById('notesViewSection').style.display = 'none';
        document.getElementById('notesEditSection').style.display = 'block';
    });
    
    document.getElementById('cancelNotesBtn').addEventListener('click', function() {
        document.getElementById('notesViewSection').style.display = 'block';
        document.getElementById('notesEditSection').style.display = 'none';
    });
    
    // Toggle follow-up options based on checkbox
    document.getElementById('followUpNeeded').addEventListener('change', function() {
        document.getElementById('followUpOptions').style.display = this.checked ? 'block' : 'none';
        
        // Set default date if not already set
        if (this.checked && !document.getElementById('followUpDate').value) {
            const today = new Date();
            const followUpDate = new Date(today);
            followUpDate.setDate(today.getDate() + 7); // Default to 1 week from now
            
            const year = followUpDate.getFullYear();
            const month = String(followUpDate.getMonth() + 1).padStart(2, '0');
            const day = String(followUpDate.getDate()).padStart(2, '0');
            
            document.getElementById('followUpDate').value = `${year}-${month}-${day}`;
        }
    });
    
    // Handle form submission
    document.getElementById('notesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Collect form data
        const notes = document.getElementById('notesTextarea').value;
        const followUpNeeded = document.getElementById('followUpNeeded').checked;
        const followUpDate = followUpNeeded ? document.getElementById('followUpDate').value : null;
        const followUpPriority = followUpNeeded ? document.getElementById('followUpPriority').value : null;
        
        // Create update data
        const updateData = {
            notes: notes,
            follow_up_needed: followUpNeeded
        };
        
        if (followUpNeeded) {
            updateData.follow_up_date = followUpDate ? new Date(followUpDate).toISOString() : null;
            updateData.follow_up_priority = followUpPriority;
        }
        
        // Send update request
        fetch(`/api/v1/assessments/${assessmentId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(result => {
            // Update notes view
            document.getElementById('notesContent').textContent = notes || 'No clinical notes recorded.';
            
            // Switch back to view mode
            document.getElementById('notesViewSection').style.display = 'block';
            document.getElementById('notesEditSection').style.display = 'none';
            
            // Reload assessment to update other sections
            loadAssessment();
            
            // Show success message
            alert('Assessment notes updated successfully!');
        })
        .catch(error => {
            console.error('Error updating assessment:', error);
            let errorMessage = 'Failed to update assessment notes.';
            
            if (error.messages) {
                errorMessage += ' ' + Object.values(error.messages).flat().join(', ');
            }
            
            alert(errorMessage);
        });
    });
    
    // Schedule follow-up button
    document.getElementById('scheduleFollowupBtn').addEventListener('click', function() {
        if (!assessmentData || !assessmentData.patient_id) {
            alert('Unable to schedule follow-up. Patient information not available.');
            return;
        }
        
        // Use the follow-up date from the assessment if available
        const followUpDate = assessmentData.follow_up_date 
            ? new Date(assessmentData.follow_up_date) 
            : null;
        
        // Store patient ID for call scheduling page
        localStorage.setItem('schedule_call_patient_id', assessmentData.patient_id);
        
        // Navigate to call scheduling page
        window.location.href = '/calls/schedule';
    });
    
    // Function to fix token issues and retry loading
    function fixTokenAndRetry() {
        console.log("Attempting to fix authentication and retry...");
        
        // Reset token to use our demo token
        localStorage.setItem('auth_token', 'demo-token-for-testing-retry');
        
        // Create a fake user for the demo
        localStorage.setItem('current_user', JSON.stringify({
            id: 1,
            username: 'demo_user',
            full_name: 'Demo User',
            role: 'ADMIN'  // Use ADMIN to bypass permissions
        }));
        
        // Modify the API endpoint's permission check (for demo only)
        window.bypassAuthCheck = true;
        
        // Add a direct bypass query parameter
        const apiUrl = `/api/v1/assessments/${assessmentId}?bypass_auth=true`;
        
        // Try a different approach - use a form post to get the data
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/api/v1/debug/get_assessment/${assessmentId}`;
        document.body.appendChild(form);
        
        // Show message
        document.getElementById('assessmentInfoCard').innerHTML = `
            <div class="alert alert-info">
                <p><i class="fas fa-sync fa-spin me-2"></i> Attempting alternative data loading method...</p>
            </div>
        `;
        
        // Try to load the assessment again with normal method first
        loadAssessment();
    }
    
    // Process and display symptoms independently of protocol
    function processAndDisplaySymptoms(data) {
        const symptomsContent = document.getElementById('symptomsCard');
        // Create a more standardized symptoms object with fallbacks and validations
        let processedSymptoms = {};
        
        // Check if symptoms data exists and is in expected format
        if (data.symptoms && typeof data.symptoms === 'object') {
            // Create a standardized copy of the symptoms with validation
            Object.entries(data.symptoms).forEach(([symptom, severity]) => {
                // Convert any non-numeric severity to 0 or the provided value
                const numericSeverity = typeof severity === 'number' 
                    ? severity 
                    : (typeof severity === 'object' && severity?.value && !isNaN(severity.value)) 
                        ? Number(severity.value) 
                        : 0;
                        
                // Only include valid symptom data
                if (symptom && numericSeverity !== undefined) {
                    processedSymptoms[symptom] = numericSeverity;
                }
            });
        }
        
        console.log("Processed symptoms:", processedSymptoms);
        
        if (Object.keys(processedSymptoms).length > 0) {
            // Sort symptoms by severity (descending)
            const sortedSymptoms = Object.entries(processedSymptoms)
                .filter(([_, severity]) => typeof severity === 'number')
                .sort((a, b) => b[1] - a[1]);
            
            let symptomsHtml = '<div class="table-responsive"><table class="table table-hover">';
            symptomsHtml += '<thead><tr><th>Symptom</th><th>Severity</th><th>Level</th></tr></thead><tbody>';
            
            sortedSymptoms.forEach(([symptom, severity]) => {
                // Determine severity level
                let levelClass = 'bg-success';
                let levelText = 'Mild';
                
                if (severity >= 7) {
                    levelClass = 'bg-danger';
                    levelText = 'Severe';
                } else if (severity >= 4) {
                    levelClass = 'bg-warning';
                    levelText = 'Moderate';
                }
                
                // Format symptom name for display
                const symptomDisplay = symptom.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                symptomsHtml += `
                    <tr>
                        <td>${symptomDisplay}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${levelClass}" role="progressbar" style="width: ${severity * 10}%;" 
                                     aria-valuenow="${severity}" aria-valuemin="0" aria-valuemax="10">
                                    ${severity}/10
                                </div>
                            </div>
                        </td>
                        <td><span class="badge ${levelClass}">${levelText}</span></td>
                    </tr>
                `;
            });
            
            symptomsHtml += '</tbody></table></div>';
            symptomsContent.innerHTML = symptomsHtml;
        } else {
            symptomsContent.innerHTML = '<p>No symptoms reported.</p>';
        }
    }
    
    // Process and display interventions independently of protocol
    function processAndDisplayInterventions(data) {
        const interventionsContent = document.getElementById('interventionsCard');
        
        // Validate and standardize interventions data
        let validInterventions = [];
        if (data.interventions) {
            // Ensure interventions is an array
            const interventionsArray = Array.isArray(data.interventions) 
                ? data.interventions 
                : typeof data.interventions === 'object' 
                    ? [data.interventions] 
                    : [];
            
            // Process each intervention
            interventionsArray.forEach(intervention => {
                // Skip invalid interventions
                if (!intervention || typeof intervention !== 'object') {
                    return;
                }
                
                // Add to valid interventions
                validInterventions.push(intervention);
            });
        }
        
        console.log("Valid interventions:", validInterventions);
        
        if (validInterventions.length > 0) {
            let interventionsHtml = '<ul class="list-group">';
            
            validInterventions.forEach(intervention => {
                // Handle various intervention formats
                const title = intervention.title || intervention.name || intervention.id || "Intervention";
                const description = intervention.description || "";
                
                // Determine priority class (if available)
                let priorityClass = 'bg-info';
                let priorityText = '';
                
                if (intervention.priority) {
                    if (intervention.priority === 'high') priorityClass = 'bg-danger';
                    if (intervention.priority === 'medium') priorityClass = 'bg-warning';
                    if (intervention.priority === 'low') priorityClass = 'bg-success';
                    priorityText = `<span class="badge ${priorityClass}">${intervention.priority.toUpperCase()}</span>`;
                } else if (intervention.severity_threshold) {
                    // Use severity threshold as alternative
                    if (intervention.severity_threshold >= 7) {
                        priorityClass = 'bg-danger';
                        priorityText = '<span class="badge bg-danger">HIGH</span>';
                    } else if (intervention.severity_threshold >= 4) {
                        priorityClass = 'bg-warning';
                        priorityText = '<span class="badge bg-warning">MEDIUM</span>';
                    } else {
                        priorityClass = 'bg-success';
                        priorityText = '<span class="badge bg-success">LOW</span>';
                    }
                }
                
                interventionsHtml += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6>${title}</h6>
                            ${priorityText}
                        </div>
                        <p>${description}</p>
                        ${intervention.instructions ? `<small class="text-muted">${intervention.instructions}</small>` : ''}
                    </li>
                `;
            });
            
            interventionsHtml += '</ul>';
            interventionsContent.innerHTML = interventionsHtml;
        } else {
            interventionsContent.innerHTML = '<p>No interventions recommended.</p>';
        }
    }
    
    // Process and display responses independently of protocol
    function processAndDisplayResponses(data) {
        const responsesContent = document.getElementById('responsesCard');
        
        // Check if responses exist
        if (!data.responses || typeof data.responses !== 'object' || Object.keys(data.responses).length === 0) {
            responsesContent.innerHTML = '<p>No responses recorded.</p>';
            return;
        }
        
        // Standardize responses data
        const standardizedResponses = {};
        
        // Process each response
        Object.entries(data.responses).forEach(([questionId, response]) => {
            // Handle different response formats
            if (questionId) {
                if (typeof response === 'object' && response !== null) {
                    standardizedResponses[questionId] = response;
                } else {
                    // Create a standard format for non-object responses
                    standardizedResponses[questionId] = {
                        value: response,
                        notes: ''
                    };
                }
            }
        });
        
        console.log("Standardized responses:", standardizedResponses);
        
        // Simple display format when protocol is not available
        if (Object.keys(standardizedResponses).length > 0) {
            let responsesHtml = '<div class="table-responsive"><table class="table table-striped">';
            responsesHtml += '<thead><tr><th>Question</th><th>Response</th><th>Notes</th></tr></thead><tbody>';
            
            Object.entries(standardizedResponses).forEach(([questionId, response]) => {
                // Format the response for display
                let responseDisplay;
                if (typeof response.value === 'object') {
                    responseDisplay = JSON.stringify(response.value);
                } else if (response.value === null || response.value === undefined) {
                    responseDisplay = 'No response';
                } else {
                    responseDisplay = String(response.value);
                }
                
                // Format question ID for display when we don't have the actual question text
                const questionDisplay = questionId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                responsesHtml += `
                    <tr>
                        <td>${questionDisplay}</td>
                        <td><strong>${responseDisplay}</strong></td>
                        <td>${response.notes || ''}</td>
                    </tr>
                `;
            });
            
            responsesHtml += '</tbody></table></div>';
            responsesContent.innerHTML = responsesHtml;
        } else {
            responsesContent.innerHTML = '<p>No responses recorded.</p>';
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadAssessment();
    });
</script>
{% endblock %}
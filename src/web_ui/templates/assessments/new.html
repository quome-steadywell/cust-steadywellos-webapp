{% extends "base.html" %}

{% block title %}New Assessment - SteadywellOS{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2><i class="fas fa-clipboard-list me-2"></i>New Assessment</h2>
    </div>
    <div class="col-md-6 text-md-end">
        <a href="/assessments" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Assessments
        </a>
    </div>
</div>

<!-- We'll check if the patient_id is provided -->
{% if patient_id %}
<!-- Patient was provided in the URL, show normal flow -->
<div id="patientInfo" class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Patient Information</h5>
    </div>
    <div class="card-body text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading patient information...</p>
    </div>
</div>

<div id="protocolInfo" class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Protocol Information</h5>
        <span id="protocolBadge" class="badge bg-primary">Loading...</span>
    </div>
    <div class="card-body text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading protocol information...</p>
    </div>
</div>
{% else %}
<!-- No patient_id was provided, show patient selection UI -->
<div id="patientInfo" class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Select Patient</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            Please select a patient to create an assessment
        </div>
        <div class="mb-3">
            <label for="patientSearch" class="form-label">Search Patient</label>
            <div class="input-group">
                <input type="text" class="form-control" id="patientSearch" placeholder="Search by name or MRN...">
                <button class="btn btn-primary" type="button" id="searchButton">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
        <div id="patientResults" class="mt-3">
            <p class="text-muted">Enter a search term to find patients...</p>
        </div>
    </div>
</div>

<div id="protocolInfo" class="card mb-4 d-none">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Protocol Information</h5>
        <span id="protocolBadge" class="badge bg-primary">Loading...</span>
    </div>
    <div class="card-body text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading protocol information...</p>
    </div>
</div>
{% endif %}

<form id="assessmentForm" class="needs-validation" novalidate>
    <input type="hidden" id="patientId" name="patientId" value="{{ patient_id }}">
    <input type="hidden" id="protocolId" name="protocolId">

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Assessment Questions</h5>
        </div>
        <div class="card-body">
            <div id="questionContainer">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading questions...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Additional Notes</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="notes" class="form-label">Clinical Notes</label>
                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Enter any additional observations or notes..."></textarea>
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="followUpNeeded" name="followUpNeeded">
                    <label class="form-check-label" for="followUpNeeded">
                        Follow-up Needed
                    </label>
                </div>
            </div>

            <div id="followUpFields" class="d-none">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="followUpDate" class="form-label">Follow-up Date</label>
                        <input type="date" class="form-control" id="followUpDate" name="followUpDate">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="followUpPriority" class="form-label">Priority</label>
                        <select class="form-select" id="followUpPriority" name="followUpPriority">
                            <option value="LOW">Low</option>
                            <option value="MEDIUM" selected>Medium</option>
                            <option value="HIGH">High</option>
                            <option value="URGENT">Urgent</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="text-end mb-4">
        <button type="button" id="generateBtn" class="btn btn-primary me-2">
            <i class="fas fa-magic me-1"></i> Generate AI Recommendations
        </button>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-1"></i> Complete Assessment
        </button>
    </div>
</form>

<div id="aiRecommendationsCard" class="card mb-4 d-none">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Recommendations</h5>
    </div>
    <div class="card-body">
        <div id="aiContent" class="mb-3">
            <div class="placeholder-glow">
                <span class="placeholder col-12"></span>
                <span class="placeholder col-6"></span>
                <span class="placeholder col-8"></span>
                <span class="placeholder col-10"></span>
            </div>
        </div>
        <div id="interventionsList"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Get patient ID from the form
    let patientId = document.getElementById('patientId').value;
    console.log('Initial patientId from form:', patientId);

    // Check if patientId is empty string and convert to null
    if (patientId === '') {
        patientId = null;
        console.log('Converted empty patientId to null');
    }

    let protocolData = null;
    let patientData = null;
    let responses = {};

    // Show patient selection UI when no patient_id is provided
    function showPatientSelectionUI() {
        console.log('Showing patient selection UI');
        const patientInfoCard = document.getElementById('patientInfo');
        const patientInfoBody = patientInfoCard.querySelector('.card-body');

        // Hide other sections
        document.getElementById('protocolInfo').classList.add('d-none');
        document.getElementById('questionContainer').parentElement.classList.add('d-none');
        document.getElementById('generateBtn').disabled = true;

        // Update card header
        patientInfoCard.querySelector('.card-header h5').textContent = 'Select Patient';

        // Update body with patient selection form
        patientInfoBody.innerHTML = `
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Please select a patient to create an assessment
            </div>
            <div class="mb-3">
                <label for="patientSearch" class="form-label">Search Patient</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="patientSearch" placeholder="Search by name or MRN...">
                    <button class="btn btn-primary" type="button" id="searchButton">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </div>
            <div id="patientResults" class="mt-3">
                <p class="text-muted">Enter a search term to find patients...</p>
            </div>
        `;
        // Event listeners for search are added here
        setTimeout(() => {
            const searchButton = document.getElementById('searchButton');
            const searchInput = document.getElementById('patientSearch');

            if (searchButton && searchInput) {
                searchButton.addEventListener('click', searchPatients);
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchPatients();
                    }
                });

                // Focus on the search input
                searchInput.focus();
            } else {
                console.error('Could not find search elements');
            }
        }, 100);
    }

    // Search for patients
    function searchPatients() {
        const searchTerm = document.getElementById('patientSearch').value.trim();
        const resultsContainer = document.getElementById('patientResults');

        if (!searchTerm) {
            resultsContainer.innerHTML = '<p class="text-muted">Please enter a search term...</p>';
            return;
        }

        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = '<p class="text-muted">Please enter at least 2 characters for search...</p>';
            return;
        }

        resultsContainer.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Searching patients...</p>
            </div>
        `;

        const searchUrl = `/api/v1/patients/search?q=${encodeURIComponent(searchTerm)}`;
        console.log(`Making search request to: ${searchUrl}`);

        fetch(searchUrl, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
            }
        })
        .then(response => {
            console.log(`Search response status: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Raw search API response:', JSON.stringify(data, null, 2));

            // Check if data is wrapped in another object
            let patients = data;
            if (data.patients && Array.isArray(data.patients)) {
                console.log('Patients array found inside data.patients');
                patients = data.patients;
            }

            console.log(`Found ${patients.length} patients in search results`);

            if (patients.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No patients found matching "${searchTerm}".
                    </div>
                `;
                return;
            }

            let resultsHtml = `
                <div class="list-group">
            `;

            console.log('Patient search results:', patients);
            patients.forEach(patient => {
                // Debug the patient object with more detailed logging
                console.log('Raw patient data in search:', JSON.stringify(patient, null, 2));

                // Log all properties of the patient object
                console.log('Patient object properties:');
                for (const key in patient) {
                    console.log(`- ${key}: ${JSON.stringify(patient[key])}`);
                }

                // Try to find the name properties from the schema
                let patientName = 'Unknown';

                // Check for full_name property first (from PatientListSchema)
                if (patient.full_name) {
                    patientName = patient.full_name;
                    console.log(`Found full_name: ${patientName}`);
                }
                // If no full_name, try first_name and last_name
                else if (patient.first_name || patient.last_name) {
                    patientName = `${patient.first_name || ''} ${patient.last_name || ''}`.trim();
                    console.log(`Constructed name from first/last: ${patientName}`);
                }
                // Check nested under 'patient'
                else if (patient.patient) {
                    if (patient.patient.full_name) {
                        patientName = patient.patient.full_name;
                        console.log(`Found nested full_name: ${patientName}`);
                    }
                    else if (patient.patient.first_name || patient.patient.last_name) {
                        patientName = `${patient.patient.first_name || ''} ${patient.patient.last_name || ''}`.trim();
                        console.log(`Constructed name from nested first/last: ${patientName}`);
                    }
                }

                if (patientName === 'Unknown') {
                    console.warn('Could not find patient name in search result:', patient);
                }

                // Access nested properties properly depending on response structure
                // Sometimes the data is nested under 'patient' property
                const patientData = patient.patient || patient;

                // Log the final data we're using
                console.log('Using patient data:', JSON.stringify(patientData, null, 2));

                // Determine badge class based on protocol type
                let badgeClass = 'bg-secondary';
                const protocolType = patientData.protocol_type || 'UNKNOWN';

                switch(protocolType) {
                    case 'CANCER':
                        badgeClass = 'bg-danger';
                        break;
                    case 'HEART_FAILURE':
                        badgeClass = 'bg-warning text-dark';
                        break;
                    case 'COPD':
                        badgeClass = 'bg-info text-dark';
                        break;
                    case 'DEMENTIA':
                        badgeClass = 'bg-primary';
                        break;
                }

                // Format protocol type for display
                const protocolDisplay = protocolType.replace(/_/g, ' ');

                // Format date of birth safely
                let dobDisplay = 'Unknown';
                let ageDisplay = '';

                if (patientData.date_of_birth) {
                    try {
                        const dob = new Date(patientData.date_of_birth);
                        if (!isNaN(dob.getTime())) {
                            dobDisplay = dob.toLocaleDateString();
                            ageDisplay = patientData.age ? ` (${patientData.age} years)` : '';
                        }
                    } catch (e) {
                        console.error('Error formatting date:', e);
                    }
                }

                // Use the patient name we found
                resultsHtml += `
                    <button type="button" class="list-group-item list-group-item-action"
                            data-patient-id="${patientData.id}" onclick="selectPatient(${patientData.id})">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-1">${patientName}</h6>
                            <div>
                                <span class="badge ${badgeClass} me-2">${protocolDisplay}</span>
                                <span class="badge bg-secondary">MRN: ${patientData.mrn || 'Unknown'}</span>
                            </div>
                        </div>
                        <p class="mb-1 small">${patientData.primary_diagnosis || 'No diagnosis recorded'}</p>
                        <div class="d-flex justify-content-between">
                            <small>${dobDisplay}${ageDisplay}</small>
                            <small class="text-muted">${patientData.is_active ? 'Active' : 'Inactive'}</small>
                        </div>
                    </button>
                `;
            });

            resultsHtml += `
                </div>
            `;

            resultsContainer.innerHTML = resultsHtml;
        })
        .catch(error => {
            console.error('Error searching patients:', error);
            resultsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error searching patients: ${error.message}
                </div>
            `;
        });
    }

    // Select a patient and continue with assessment
    function selectPatient(selectedPatientId) {
        console.log('selectPatient called with ID:', selectedPatientId);

        // Ensure patientId is a number
        selectedPatientId = parseInt(selectedPatientId, 10);

        // Update patient ID in form
        document.getElementById('patientId').value = selectedPatientId;

        // Reset patient info card header
        document.getElementById('patientInfo').querySelector('.card-header h5').textContent = 'Patient Information';

        // Re-enable UI elements
        document.getElementById('protocolInfo').classList.remove('d-none');
        document.getElementById('questionContainer').parentElement.classList.remove('d-none');

        // Load patient data with the selected ID
        patientId = selectedPatientId;
        loadPatientInfo();
    }

    // Load patient information
    function loadPatientInfo() {
        console.log('loadPatientInfo called, patientId:', patientId);
        console.log('Current URL path:', window.location.pathname);

        // Check if auth token exists
        const authToken = localStorage.getItem('auth_token');
        console.log('Auth token exists:', !!authToken);

        // Direct approach for new assessment page without a patient
        if (window.location.pathname === '/assessments/new' && (!patientId || patientId === '')) {
            console.log('On new assessment page without patient ID, forcing selection UI');
            showPatientSelectionUI();
            return;
        }

        // If no patient_id was provided or it's an empty string, show patient selection UI
        if (!patientId || patientId === '') {
            console.log('No patientId provided or empty string, showing selection UI');
            showPatientSelectionUI();
            return;
        }

        console.log(`Fetching patient data for ID: ${patientId}`);
        const url = `/api/v1/patients/${patientId}`;
        console.log(`Request URL: ${url}`);
        console.log(`Using auth token: ${authToken ? authToken.substring(0, 10) + '...' : 'none'}`);

        fetch(url, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        })
            .then(response => {
                console.log(`Response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(response => {
                console.log('Raw response from patient API:', response);

                // Handle different API response structures
                let patient;
                if (response.patient) {
                    patient = response.patient; // Sometimes nested under 'patient'
                } else {
                    patient = response; // Sometimes directly in response
                }

                patientData = patient;

                // Log the cleaned patient data
                console.log('Parsed patient data:', patient);

                // Format date of birth safely
                let dobDisplay = 'Unknown';
                let ageDisplay = '';

                if (patient.date_of_birth) {
                    try {
                        const dob = new Date(patient.date_of_birth);
                        if (!isNaN(dob.getTime())) {
                            dobDisplay = dob.toLocaleDateString();
                            ageDisplay = patient.age ? ` (${patient.age} years)` : '';
                        }
                    } catch (e) {
                        console.error('Error formatting date:', e);
                    }
                }

                // Clean up protocol type display
                let protocolDisplay = patient.protocol_type || 'Unknown';
                if (protocolDisplay.startsWith('ProtocolType.')) {
                    protocolDisplay = protocolDisplay.replace('ProtocolType.', '').replace(/_/g, ' ');
                }

                // Get the patient name
                let patientName = 'Unknown';

                // Check for full_name property first
                if (patient.full_name) {
                    patientName = patient.full_name;
                    console.log(`Using full_name for detail: ${patientName}`);
                }
                // If no full_name, try first_name and last_name
                else if (patient.first_name || patient.last_name) {
                    patientName = `${patient.first_name || ''} ${patient.last_name || ''}`.trim();
                    console.log(`Using constructed name for detail: ${patientName}`);
                }

                // Update UI with patient data
                const patientInfoHtml = `
                    <div class="row">
                        <div class="col-md-6 text-start">
                            <h4>${patientName}</h4>
                            <p class="text-muted">MRN: ${patient.mrn || 'Not available'}</p>
                            <p><strong>DOB:</strong> ${dobDisplay}${ageDisplay}</p>
                            <p><strong>Primary Diagnosis:</strong> ${patient.primary_diagnosis || 'Not specified'}</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <p><strong>Phone:</strong> ${patient.phone_number || 'Not available'}</p>
                            <p><strong>Protocol Type:</strong> ${protocolDisplay}</p>
                            <p><strong>Allergies:</strong> ${patient.allergies || 'None'}</p>
                            <p><strong>${patient.dnr_status ? 'DNR Status: YES' : ''}</strong></p>
                        </div>
                    </div>
                `;

                document.getElementById('patientInfo').querySelector('.card-body').innerHTML = patientInfoHtml;

                // Store the original protocol type for debugging
                console.log(`Patient protocol type: ${patient.protocol_type}`);

                // Normalize the protocol type before loading protocol
                let normalizedProtocolType = patient.protocol_type;

                // Extract the enum value if it's in the format ProtocolType.COPD
                if (normalizedProtocolType && normalizedProtocolType.startsWith('ProtocolType.')) {
                    normalizedProtocolType = normalizedProtocolType.replace('ProtocolType.', '');
                }

                // Handle case issues by trying both uppercase and lowercase
                if (normalizedProtocolType) {
                    // Try various formats to ensure we can find the protocol
                    console.log(`Trying to load protocol for normalized type: ${normalizedProtocolType}`);
                    loadProtocol(normalizedProtocolType);
                } else {
                    console.error('No protocol type found for patient');
                    document.getElementById('protocolInfo').querySelector('.card-body').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            No protocol type found for this patient.
                        </div>
                    `;
                    document.getElementById('protocolBadge').textContent = 'Error';
                    document.getElementById('protocolBadge').className = 'badge bg-danger';
                }
            })
            .catch(error => {
                console.error('Error loading patient:', error);
                document.getElementById('patientInfo').querySelector('.card-body').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error loading patient information. Please try again later.
                    </div>
                `;
            });
    }

    // Load protocol information
    function loadProtocol(protocolType) {
        console.log(`Loading protocol for type: ${protocolType}`);

        if (!protocolType) {
            console.error('No protocol type provided');
            document.getElementById('protocolInfo').querySelector('.card-body').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    No protocol type specified for this patient.
                </div>
            `;
            document.getElementById('protocolBadge').textContent = 'Error';
            document.getElementById('protocolBadge').className = 'badge bg-danger';
            return;
        }

        // Clean up protocol type if it comes in as ProtocolType.XXX format
        let cleanProtocolType = protocolType;
        if (protocolType && protocolType.startsWith('ProtocolType.')) {
            cleanProtocolType = protocolType.replace('ProtocolType.', '');
            console.log(`Cleaned protocol type: ${cleanProtocolType}`);
        }

        // Convert to lowercase to match the ProtocolType enum values
        cleanProtocolType = cleanProtocolType.toLowerCase();
        console.log(`Using lowercase protocol type: ${cleanProtocolType}`);

        const url = `/api/v1/protocols/type/${cleanProtocolType}/latest`;
        const authToken = localStorage.getItem('auth_token');
        console.log(`Protocol request URL: ${url}`);

        fetch(url, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        })
            .then(response => {
                console.log(`Protocol response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(protocol => {
                console.log('Protocol data received:', protocol);
                protocolData = protocol;

                // Update hidden protocol ID
                document.getElementById('protocolId').value = protocol.id;

                // Update protocol badge
                const protocolBadge = document.getElementById('protocolBadge');
                protocolBadge.textContent = protocol.name;

                // Update protocol information
                const protocolInfoHtml = `
                    <div class="row">
                        <div class="col-md-12">
                            <p>${protocol.description}</p>
                            <p><strong>Version:</strong> ${protocol.version}</p>
                            <p><strong>Questions:</strong> ${protocol.questions ? protocol.questions.length : 0}</p>
                        </div>
                    </div>
                `;

                document.getElementById('protocolInfo').querySelector('.card-body').innerHTML = protocolInfoHtml;

                // Load questions
                renderQuestions(protocol.questions);
            })
            .catch(error => {
                console.error('Error loading protocol:', error);

                // Try alternative methods in sequence
                const typesToTry = [
                    cleanProtocolType.toUpperCase(),                // Try COPD
                    cleanProtocolType,                              // Try copd
                    protocolType,                                   // Try original (ProtocolType.COPD)
                    protocolType.replace('ProtocolType.', '')       // Try COPD again
                ];

                console.log(`Will try these protocol types: ${typesToTry.join(', ')}`);

                // Try each type in sequence
                tryNextProtocolType(typesToTry, 0, authToken);
            });
    }

    // Helper function to try different protocol types in sequence
    function tryNextProtocolType(types, index, authToken) {
        // If we've tried all types, show error
        if (index >= types.length) {
            console.error('All protocol type attempts failed');
            document.getElementById('protocolInfo').querySelector('.card-body').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading protocol information. Please try again later.
                </div>
            `;
            document.getElementById('protocolBadge').textContent = 'Error';
            document.getElementById('protocolBadge').className = 'badge bg-danger';
            return;
        }

        const currentType = types[index];
        console.log(`Trying protocol type attempt ${index+1}/${types.length}: ${currentType}`);

        fetch(`/api/v1/protocols/type/${currentType}/latest`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        })
        .then(response => {
            console.log(`Protocol response status for ${currentType}: ${response.status}`);
            if (!response.ok) {
                // Try next protocol type
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(protocol => {
            console.log(`Successfully loaded protocol with type: ${currentType}`, protocol);
            protocolData = protocol;

            // Update hidden protocol ID
            document.getElementById('protocolId').value = protocol.id;

            // Update protocol badge
            const protocolBadge = document.getElementById('protocolBadge');
            protocolBadge.textContent = protocol.name;

            // Update protocol information
            const protocolInfoHtml = `
                <div class="row">
                    <div class="col-md-12">
                        <p>${protocol.description}</p>
                        <p><strong>Version:</strong> ${protocol.version}</p>
                        <p><strong>Questions:</strong> ${protocol.questions ? protocol.questions.length : 0}</p>
                    </div>
                </div>
            `;

            document.getElementById('protocolInfo').querySelector('.card-body').innerHTML = protocolInfoHtml;

            // Load questions
            renderQuestions(protocol.questions);
        })
        .catch(error => {
            console.error(`Error loading protocol with type ${currentType}:`, error);
            // Try next protocol type
            tryNextProtocolType(types, index + 1, authToken);
        });
    }

    // Render protocol questions
    function renderQuestions(questions) {
        if (!questions || questions.length === 0) {
            document.getElementById('questionContainer').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No questions found for this protocol.
                </div>
            `;
            return;
        }

        // Group questions by category
        const categories = {};
        questions.forEach(question => {
            const category = question.category || 'General';
            if (!categories[category]) {
                categories[category] = [];
            }
            categories[category].push(question);
        });

        let questionsHtml = '';

        // For each category, create a section
        Object.entries(categories).forEach(([category, categoryQuestions], index) => {
            questionsHtml += `
                <div class="mb-4">
                    <h5 class="border-bottom pb-2">${category}</h5>
                    <div class="ms-3">
            `;

            // Add questions for this category
            categoryQuestions.forEach(question => {
                questionsHtml += `
                    <div class="mb-3" data-question-id="${question.id}">
                        <label class="form-label fw-bold">${question.text}${question.required ? ' <span class="text-danger">*</span>' : ''}</label>
                `;

                // Render appropriate input based on question type
                if (question.type === 'numeric') {
                    const min = question.min_value !== undefined ? question.min_value : 0;
                    const max = question.max_value !== undefined ? question.max_value : 10;

                    questionsHtml += `
                        <div class="range-wrapper">
                            <input type="range" class="form-range"
                                id="${question.id}"
                                name="${question.id}"
                                min="${min}"
                                max="${max}"
                                value="${min}"
                                ${question.required ? 'required' : ''}
                                oninput="document.getElementById('${question.id}_value').textContent = this.value">
                            <div class="d-flex justify-content-between">
                                <span>${min}</span>
                                <span class="fw-bold" id="${question.id}_value">${min}</span>
                                <span>${max}</span>
                            </div>
                        </div>
                    `;
                } else if (question.type === 'boolean') {
                    questionsHtml += `
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio"
                                    name="${question.id}"
                                    id="${question.id}_yes"
                                    value="true"
                                    ${question.required ? 'required' : ''}>
                                <label class="form-check-label" for="${question.id}_yes">Yes</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio"
                                    name="${question.id}"
                                    id="${question.id}_no"
                                    value="false"
                                    ${question.required ? 'required' : ''}>
                                <label class="form-check-label" for="${question.id}_no">No</label>
                            </div>
                        </div>
                    `;
                } else if (question.type === 'choice' && question.choices) {
                    questionsHtml += `<select class="form-select" id="${question.id}" name="${question.id}" ${question.required ? 'required' : ''}>`;
                    questionsHtml += `<option value="">Select an option</option>`;

                    question.choices.forEach(choice => {
                        questionsHtml += `<option value="${choice}">${choice}</option>`;
                    });

                    questionsHtml += `</select>`;
                } else {
                    // Default to text input
                    questionsHtml += `
                        <input type="text" class="form-control"
                            id="${question.id}"
                            name="${question.id}"
                            placeholder="Enter your response"
                            ${question.required ? 'required' : ''}>
                    `;
                }

                questionsHtml += `
                    </div>
                `;
            });

            questionsHtml += `
                    </div>
                </div>
            `;
        });

        document.getElementById('questionContainer').innerHTML = questionsHtml;

        // Add event listeners to all form inputs
        document.querySelectorAll('#questionContainer input, #questionContainer select').forEach(input => {
            input.addEventListener('change', function() {
                updateResponses();
            });
        });
    }

    // Update responses object when inputs change
    function updateResponses() {
        responses = {};

        document.querySelectorAll('#questionContainer [data-question-id]').forEach(questionDiv => {
            const questionId = questionDiv.dataset.questionId;
            const inputElement = document.getElementById(questionId);

            if (inputElement) {
                if (inputElement.type === 'range') {
                    responses[questionId] = {
                        value: parseInt(inputElement.value)
                    };
                } else if (inputElement.type === 'text' || inputElement.tagName === 'SELECT') {
                    responses[questionId] = {
                        value: inputElement.value
                    };
                }
            } else {
                // Handle radio buttons
                const radioYes = document.getElementById(`${questionId}_yes`);
                const radioNo = document.getElementById(`${questionId}_no`);

                if (radioYes && radioNo) {
                    if (radioYes.checked) {
                        responses[questionId] = {
                            value: true
                        };
                    } else if (radioNo.checked) {
                        responses[questionId] = {
                            value: false
                        };
                    }
                }
            }
        });

        // Enable/disable generate button based on if all required questions are answered
        const generateBtn = document.getElementById('generateBtn');
        const form = document.getElementById('assessmentForm');

        // Use form validation to check required fields
        if (form.checkValidity()) {
            generateBtn.disabled = false;
        } else {
            generateBtn.disabled = true;
        }
    }

    // Generate symptoms object from responses
    function generateSymptoms() {
        const symptoms = {};

        if (protocolData && protocolData.questions) {
            protocolData.questions.forEach(question => {
                if (question.symptom_type && responses[question.id]) {
                    symptoms[question.symptom_type] = responses[question.id].value;
                }
            });
        }

        return symptoms;
    }

    // Generate intervention recommendations based on symptoms and decision tree
    function generateInterventionRecommendations() {
        const symptoms = generateSymptoms();
        const interventionIds = new Set();

        if (protocolData && protocolData.decision_tree) {
            protocolData.decision_tree.forEach(node => {
                if (node.symptom_type && symptoms[node.symptom_type]) {
                    const symptomValue = symptoms[node.symptom_type];

                    let conditionMet = false;
                    switch (node.condition) {
                        case '>=':
                            conditionMet = symptomValue >= node.value;
                            break;
                        case '>':
                            conditionMet = symptomValue > node.value;
                            break;
                        case '<=':
                            conditionMet = symptomValue <= node.value;
                            break;
                        case '<':
                            conditionMet = symptomValue < node.value;
                            break;
                        case '==':
                        case '===':
                            conditionMet = symptomValue == node.value;
                            break;
                        default:
                            console.warn(`Unknown condition: ${node.condition}`);
                    }

                    if (conditionMet && node.intervention_ids) {
                        node.intervention_ids.forEach(id => interventionIds.add(id));
                    }
                }
            });
        }

        return Array.from(interventionIds);
    }

    // Generate AI recommendations
    function generateAIRecommendations() {
        const symptoms = generateSymptoms();
        const interventionIds = generateInterventionRecommendations();
        const interventions = [];

        // Find intervention details
        if (protocolData && protocolData.interventions) {
            interventionIds.forEach(id => {
                const intervention = protocolData.interventions.find(i => i.id === id);
                if (intervention) {
                    interventions.push(intervention);
                }
            });
        }

        // Display AI recommendations card
        const aiCard = document.getElementById('aiRecommendationsCard');
        aiCard.classList.remove('d-none');

        // Create recommendations text
        let aiContent = `<h5>Based on assessment responses:</h5>`;

        // Summarize symptoms
        aiContent += `<p>Patient reports the following symptoms:</p><ul>`;
        Object.entries(symptoms).forEach(([symptom, value]) => {
            let symptomDisplay = symptom.replace(/_/g, ' ');
            symptomDisplay = symptomDisplay.charAt(0).toUpperCase() + symptomDisplay.slice(1);

            if (typeof value === 'boolean') {
                aiContent += `<li>${symptomDisplay}: ${value ? 'Yes' : 'No'}</li>`;
            } else {
                aiContent += `<li>${symptomDisplay}: ${value}/10</li>`;
            }
        });
        aiContent += `</ul>`;

        // Add general recommendations
        aiContent += `<h5>Recommended Interventions:</h5>`;

        document.getElementById('aiContent').innerHTML = aiContent;

        // Add interventions list
        const interventionsListHtml = interventions.map(intervention => `
            <div class="card mb-2 border-left-${getInterventionPriorityClass(intervention.priority)}">
                <div class="card-body py-2">
                    <h6 class="mb-1">${intervention.title}</h6>
                    <p class="mb-1">${intervention.description}</p>
                    ${intervention.instructions ? `<p class="small mb-0 text-muted">${intervention.instructions}</p>` : ''}
                </div>
            </div>
        `).join('');

        document.getElementById('interventionsList').innerHTML = interventions.length > 0 ?
            interventionsListHtml :
            '<div class="alert alert-info">No specific interventions recommended based on this assessment.</div>';
    }

    // Get bootstrap class based on intervention priority
    function getInterventionPriorityClass(priority) {
        switch (priority) {
            case 'urgent': return 'danger';
            case 'high': return 'warning';
            case 'medium': return 'info';
            case 'low': return 'success';
            default: return 'primary';
        }
    }

    // Handle form submission
    function handleFormSubmit(event) {
        event.preventDefault();

        const form = document.getElementById('assessmentForm');

        if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        // Collect form data
        const formData = {
            patient_id: parseInt(document.getElementById('patientId').value),
            protocol_id: parseInt(document.getElementById('protocolId').value),
            responses: responses,
            symptoms: generateSymptoms(),
            notes: document.getElementById('notes').value,
            follow_up_needed: document.getElementById('followUpNeeded').checked,
            call_id: null  // In a real app, this would be linked to actual call data
        };

        // Add follow-up info if needed
        if (formData.follow_up_needed) {
            formData.follow_up_date = document.getElementById('followUpDate').value;
            formData.follow_up_priority = document.getElementById('followUpPriority').value;
        }

        // Add AI-recommended interventions
        const interventionIds = generateInterventionRecommendations();
        formData.interventions = [];

        if (protocolData && protocolData.interventions) {
            interventionIds.forEach(id => {
                const intervention = protocolData.interventions.find(i => i.id === id);
                if (intervention) {
                    formData.interventions.push(intervention);
                }
            });
        }

        // Send the data to the server
        const authToken = localStorage.getItem('auth_token');
        console.log('Submitting assessment with data:', formData);

        fetch('/api/v1/assessments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(result => {
            console.log('Assessment created:', result);
            alert('Assessment completed successfully!');
            window.location.href = '/assessments';
        })
        .catch(error => {
            console.error('Error creating assessment:', error);
            alert(`Failed to create assessment: ${error.message || 'Unknown error'}`);
        });
    }

    // Set up event listeners once the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.clear();
        console.log('DOMContentLoaded event fired');

        // Check for authentication
        if (!localStorage.getItem('auth_token')) {
            console.error('No authentication token found. Redirecting to login...');
            // Find any card body to show the error
            const cardBody = document.querySelector('.card-body');
            if (cardBody) {
                cardBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Authentication required. Please <a href="/login">log in</a> to continue.
                    </div>
                `;
            }
            setTimeout(() => {
                window.location.href = '/login';
            }, 3000);
            return;
        }

        console.log('Starting application with patientId:', patientId);

        // Set up search functionality if we're on the patient selection screen
        const searchButton = document.getElementById('searchButton');
        const searchInput = document.getElementById('patientSearch');

        if (searchButton && searchInput) {
            console.log('Setting up search event listeners');
            searchButton.addEventListener('click', searchPatients);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchPatients();
                }
            });

            // Focus on the search input
            searchInput.focus();
        } else {
            console.log('No search elements found, loading patient info');
            loadPatientInfo();
        }

        // Toggle follow-up fields
        document.getElementById('followUpNeeded').addEventListener('change', function() {
            const followUpFields = document.getElementById('followUpFields');
            if (this.checked) {
                followUpFields.classList.remove('d-none');

                // Set default follow-up date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('followUpDate').valueAsDate = tomorrow;
            } else {
                followUpFields.classList.add('d-none');
            }
        });

        // Generate recommendations button
        document.getElementById('generateBtn').addEventListener('click', generateAIRecommendations);

        // Form submission
        document.getElementById('assessmentForm').addEventListener('submit', handleFormSubmit);
    });
</script>

<style>
    /* Custom styles for priority borders */
    .border-left-danger {
        border-left: 4px solid #dc3545 !important;
    }

    .border-left-warning {
        border-left: 4px solid #ffc107 !important;
    }

    .border-left-info {
        border-left: 4px solid #17a2b8 !important;
    }

    .border-left-success {
        border-left: 4px solid #28a745 !important;
    }

    .border-left-primary {
        border-left: 4px solid #007bff !important;
    }
</style>
{% endblock %}
